# Exchange Online: Cross-tenant migration functions

*Any sample script/function in this repository is provided AS IS and not supported under any Microsoft standard support program, service and without warranty of any kind.*

## Overview:


This repository contains two scripts as functions to sync all necessary attributes between the source and target tenant before the MRS move mailbox. Before starting using the resources provided in this repository, please review the [Microsoft official document about the cross-tenant EXO migration](https://docs.microsoft.com/en-us/microsoft-365/enterprise/cross-tenant-mailbox-migration). It’s very important that you understand how the migration works in order to use these functions.



 ## Installation

 Open a Windows Powershell with "Run as Administrator" and run:
``` powershell
Install-Module T2TScripts -Force
```

Once the module is installed, you can run either of the commands and its parameters:
``` powershell
Export-T2TAttributes
Import-T2TAttributes
Export-T2Tlogs
```

If you want to check for module updates you can run:
``` powershell
Find-Module T2TScripts
```

If there is any newer version than the one you already have, you can run:
``` powershell
Update-Module T2TScripts -Force
```

If you face installation issues such as *Unable to resolve package source* you can run the following before install the module:
``` powershell
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
```

## How it works:


1 - Fill some Exchange custom attributes (1-15) with a specific value on the mailboxes that you want to migrate. This will become the filter for the function to get only mailboxes with the attribute that you choose.

2 - Understand all parameters that you may use to run the functions.

3 - From the source environment, run the `Export-T2TAttributes` function to dump the source attributes and validate yourself that the CSV generated by the function contains only remote mailboxes filtered by the custom attribute used in the step 1.

4 - From the target environment, run the `Import-T2TAttributes` function to create Mail User objects (aka MEU) in the target on-prem AD based on the CSV created in the step 3. 


## Requirement:

**Common requirements for both functions:**


- Depending on the current powershell execution policy state, it could require to be set as Unrestricted.

- You need Active Directory and Exchange Server On-Premises. In other words, the function was not developed to work in Azure AD cloud-only scenarios or with AD On-Premises in hybrid but with no Exchange On-Premises. 

- You can run the functions from an Exchange Server machine or from any other domain-joined machine as long as you set `-LocalMachineIsNotExchange` switch and the `-ExchangeHostname` parameter with Exchange Server hostname.

- If you run the functions from an Exchange Server machine, the functons will leverage the local AD module present on Exchange. Otherwise, the functions will export a PSSession from the Domain Controller which your PC is authenticated.

- The Exchange and AD PSSession are authenticated through Kerberos relying on the credential used on the Windows sign-in. Thus, be sure to sign-in using AD and Exchange admin credential.



**Export-T2TAttributes:**

- You must fill a custom attribute field with some value by your preference in order to be used by the function as a filter to get only mailboxes that have the custom attribute and value filled by you. This will provide more security once the function will not get anything else than you want to.

- You must fill a CSV that maps which souce domain will become which target domain. Start the first line as *source,target* and then map each source domain for each target domain, e.g:

    ```DomainMapping.csv
    source,target
    contoso.com,fabrikam.com
    source1.com,target1.com
    sub.source.com,sub.target.com
    ```

- The function will connect to the Exchange Online using v2 module. If you don't have it installed, this module will install it for you as long as the PC may reach the PowerShell gallery.  


**Import-T2TAttributes:**

- The function will ask you to stop Azure AD Connect sync cycle before the execution. You can leave the function to stoping it for you as long as you provide the Azure AD Connect machine hostname, or you can stop yourself before the script execution.

- Once the function finishes, you can validate that the MEU objects were successfully created and manually re-enable the Azure AD Connect sync sycle using the following cmdled: `Set-ADSyncScheduler -SyncCycleEnabled 1`

- All MEU objects will be created using the UPN suffix that you passed through `-UPNSuffix` param. If you need to create MEUs with different UPN suffix, you will need to segment the MEU creation based on the UPN suffix, it means run the function for each UPN suffix.



## Parameters:

**Export-T2TAttributes**

| Parameter | Value | Required or Optional
|-----------------------------------------|-------------------------|---------------|
| AdminUPN                                | Exchange Online administrator UPN. | Required |
| CustomAttributeNumber                   | Exchange Custom Attribute number (1-15) where the function will use to filter. | Required |
| CustomAttributeValue                    | Exchange Custom Attribute value where the function will use to filter. | Required |
| DomainMappingCSV                        | Enter the CSV path which you mapped the source and target domains. | Required |
| BypassAutoExpandingArchiveCheck         | Switch to check if there are Auto-Expanding archive mailboxes.¹ | Optional |
| IncludeSIP                              | Switch to get SIP values from proxyAddresses. Without this switch the function returns only SMTP and X500 | Optional |
| LocalMachineIsNotExchange               | Switch to be used when the function is executed from a non-Exchange Server machine. | Optional |
| ExchangeHostname                        | Exchange server hostname that the function will connect to. | Required² |
| FolderPath                              | Custom output path for the csv. if no value is defined it will be saved on Desktop. | Optional |
||||


¹ *The Auto-Expanding archive is verified because MRS does not support move mailbox of auxiliar archive mailbox. You can see the [official article for more details](https://docs.microsoft.com/en-us/microsoft-365/enterprise/cross-tenant-mailbox-migration?view=o365-worldwide#known-issues). The function will dump all mailboxes that have auxiliar Auto-Expanding archive mailbox to a TXT file. Be aware that this check might increase the function duration.*

² *Required only if `-LocalMachineIsNotExchange` is used.*

Example: Running from a non-Exchange Server
```Powershell
PS C:\> Export-T2TAttributes -AdminUPN admin@contoso.com -CustomAttributeNumber 1 -CustomAttributeValue T2T -DomainMappingCSV "C:\sourcetarget.csv" -LocalMachineIsNotExchange -ExchangeHostname ExchHostname
```


**Import-T2TAttributes**

| Parameter | Value | Required or Optional
|-----------------------------------------|-------------------------|---------------|
| UPNSuffix                               | UPN domain for the new MEU objects e.g: contoso.com  | Required |
| Password                                | Choose a password for all new MEU objects. If no password is chosen, the function will define '?r4mdon-_p@ss0rd!' as password. | Optional |
| ResetPassword                           | Require password change on first user access. | Optional |
| OrganizationalInit                      | Source domain used in your organization such as contoso.com. | Optional |
| FilePath                                | Custom output path for import the csv. if no value is defined the function will try to get it from the Desktop. | Optional |
| LocalMachineIsNotExchange               | Switch to be used when the function is executed from a non-Exchange Server machine. | Optional |
| ExchangeHostname                        | Exchange server hostname that the function will connect to. | Required¹ |
||||

¹ *Required only if `-LocalMachineIsNotExchange` is used.*

Example: Running from an Exchange Server
```Powershell
PS C:\> Import-T2TAttributes -UPNSuffix fabrikam.com -Password "P@$$w04d_Fabr!karn" -ResetPassword:$True -OrganizationalInit "Fabrikam-Users"
```


## AD Attributes

The *Export-T2TAttributes* will dump to a CSV the following attributes:

- ExchangeGuid
- EmailAddresses
- ExternalEmailAddress ¹
- legacyExchangeDN
- PrimarySMTPAddress
- Alias
- FirstName
- LastName
- DisplayName
- Name
- SamAccountName
- ArchiveGuid
- msExchSafeSendersHash
- msExchSafeRecipientsHash
- msExchBlockedSendersHash
- CustomAttribute ²
- CustomAttribute Value ²
- MailboxLocations ³
- LitigationHoldEnabled ⁴
- SingleItemRecoveryEnabled ⁴

¹ *The ExternalEmailAddress is defined by the **mail.onmicrosoft.com** [(MOERA)](https://docs.microsoft.com/en-us/troubleshoot/azure/active-directory/proxyaddresses-attribute-populate#terminology) SMTP address found on the source user object proxyAddresses property.*

² *The custom attributes number and value that will be dumped is chosen according to the user’s input before running the function*

³ *The function does not really dump the MailboxLocations attribute to the CSV but it dumps the Alias from any users that might have an Auto-Expanding archive mailbox to a TXT called AUXUser. Then you can use the AUXUser.txt to start the export PST using Content Search or eDiscovery and manually import these PST in the target tenant.*

⁴ *These properties are converted to a number which represents the ELC mailbox flag.*


## Logs

All tasks performed by both functions will generate logs that are available through the following function:
``` powershell
Export-T2Tlogs
```  

For example you can run:
``` powershell
PS C:\> Export-T2Tlogs -OutputType CSV,GridView -DaysOld 5
```  

In this example, the script will fetch all logs within the last 5 days, export to CSV to default location at the Desktop and also displays in powershell's GridView.  


## Version History  
[Change Log](/T2TScripts/changelog.md)