# Exchange Online: Cross-tenant migration functions

*Any sample script/function in this repository is provided AS IS and not supported under any Microsoft standard support program, service and without warranty of any kind.*

## Overview:

This repository contains 2 functions to sync all necessary attributes between the source and target tenant before the MRS move mailbox. Before starting using the resources provided in this repository, please review the [Microsoft official document about the cross-tenant EXO migration](https://docs.microsoft.com/en-us/microsoft-365/enterprise/cross-tenant-mailbox-migration). It’s very important that you understand how the migration works in order to use these functions.


 ## Installation

 Open a Windows Powershell with "Run as Administrator" and run:
``` powershell
Install-Module T2TScripts -Force
```
Once the module is installed, you can run either of the commands and its parameters:
``` powershell
Export-T2TAttributes
Import-T2TAttributes
Export-T2Tlogs
```

If you want to check for module updates you can run:
``` powershell
Find-Module T2TScripts
```
If there is any newer version than the one you already have, you can run:
``` powershell
Update-Module T2TScripts -Force
```

## How it works:

1 - Fill some Exchange custom attributes (1-15) with any value. This will become the filter for the function to get only mailboxes with the attribute that you choose.

2 - Understand all parameters that you may use to run the function. You can find all parameter's description on this current page or in the function itself.

3 - Run the function *Export-T2TAttributes* to dump the source mailboxes and validate yourself that the CSV generated by the function contains only mailboxes that you filter by the custom attribute.

4 - Run the *Import-T2TAttributes* function to create Mail User objects (aka MEU) in the target on-prem AD. The function will stop Azure AD Connect sync cycle or ask you to do yourself before the execution. The reason is because you might validate that all MEU objects are properly created before sync it.

5 - Re-enable the Azure AD Connect sync cycle manually – the function will not do this for you, but will provide you the cmdlet to do when you will be ready. 


## Requirement:

**Common requirements for both functions:**

- Depending on the current powershell execution policy stateg, it could require to be set as Unrestricted.

- You need Active Directory and Exchange Server On-Premises. In other words, the function was not developed to work in Azure AD cloud-only scenarios or with AD On-Premises in hybrid but with no Exchange On-Premises. 


**Export-T2TAttributes:**

- You must fill a custom attribute field with some value by your preference in order to be used by the function as a filter to get only mailboxes that have the custom attribute and value filled by you. This will provide more security once the function will not get anything else than you want to.

- You can run the function from an Exchange Server machine or from any other domain-joined machine as long as you use the switch -LocalMachineIsNotExchange and the string -ExchangeHostname to inform which Exchange the function will open the PSSession. 

- The function will connect to the Exchange Online using v2 module. If you don't have it installed, this module will install it for you as long as the PC may reach the powershell gallery.  

- If you run the function from an Exchange Server machine the function will leverage the local AD module present on Exchange. Otherwise the function will export a PSSession from the Domain Controller which authenticated your PC.   

- You need to inform a source and target domain. This value is used to convert the source domain to the target on the CSV. E.g: If you set contoso.com as source and fabrikam.com as target, the function will get all values (from the filtered custom attribute mailboxes) including alias as @contoso.com and replace to @fabrikam.com on the CSV.

## Parameters:

**Export-T2TAttributes**

| Parameter | Value | Required or Optional
|-----------------------------------------|-------------------------|---------------|
| AdminUPN                                | Exchange Online administrator UPN. | Required |
| CustomAttributeNumber                   | Exchange Custom Attribute number (1-15) where the function will use to filter. | Required |
| CustomAttributeValue                    | Exchange Custom Attribute value where the function will use to filter. | Required |
| DomainMappingCSV                        | Enter the CSV name where you mapped the source and target domains. | Required |
| BypassAutoExpandingArchiveCheck         | Switch to check if there are Auto-Expanding archive mailboxes.¹ | Optional |
| FolderPath                              | Custom output path for the csv. if no value is defined it will be saved on Desktop. | Optional |
| LocalMachineIsNotExchange               | Switch to be used when the function is executed from a non-Exchange Server machine. | Optional |
| ExchangeHostname                        | Exchange server hostname that the function will connect to. | Required² |
||||
    
¹ The Auto-Expanding archive is verified because move-mailbox of auxiliar Auto-Expanding archive mailbox is not supported, you can see the [official article for more details](https://docs.microsoft.com/en-us/microsoft-365/enterprise/cross-tenant-mailbox-migration?view=o365-worldwide#known-issues). Thus, the function will dump all mailboxes that have auxiliar Auto-Expanding archive mailbox to a TXT file. Be aware that this check might increase the function duration.

² Required only if -LocalMachineIsNotExchange is used.

**Import-T2TAttributes**

| Parameter | Value | Required or Optional
|-----------------------------------------|-------------------------|---------------|
| UPNSuffix                               | UPN domain for the new MEU objects e.g: contoso.com  | Required |
| Password                                | Choose a password for all new MEU objects. If no password is chosen, the function will define '?r4mdon-_p@ss0rd!' as password. | Optional |
| ResetPassword                           | Require password change on first user access. | Optional |
| OrganizationalInit                      | Source domain used in your organization such as contoso.com. | Optional |
| FilePath                                | Custom output path for import the csv. if no value is defined the function will try to get it from the Desktop. | Optional |
| LocalMachineIsNotExchange               | Switch to be used when the function is executed from a non-Exchange Server machine. | Optional |
| ExchangeHostname                        | Exchange server hostname that the function will connect to. | Required¹ |
||||

¹ Required only if -LocalMachineIsNotExchange is used.

## AD Attributes

The *Cross-Tenant-Migration-Attribute-Export.ps1* will dump to a CSV the following attributes:

- ExchangeGuid
- EmailAddresses
- ExternalEmailAddress
- legacyExchangeDN
- PrimarySMTPAddress
- Alias
- FirstName
- LastName
- DisplayName
- Name
- SamAccountName
- ArchiveGuid
- msExchSafeSendersHash
- msExchSafeRecipientsHash
- msExchBlockedSendersHash
- CustomAttribute ¹
- CustomAttribute Value ¹
- MailboxLocations ²
- LitigationHoldEnabled ³
- SingleItemRecoveryEnabled ³

¹ The custom attributes number and value that will be dumped is chosen according to the user’s input before running the function

² The function doesn’t really dump MailboxLocations to a CSV but it dumps the UserDisplayName from any users that might have an Auto-Expanding archive mailbox to a TXT. This is not a requirement for the migration itself, but as Microsoft doesn’t support the Auto-Expanding archive mailbox migration the function dumps it to make you aware of. 

³ These properties are converted to a number which represents the ELC mailbox flag.